#!/usr/bin/env node

var crypto = require('crypto');
var fs     = require('fs');
var netrc  = require('netrc');
var path   = require('path');
var heroku = require('heroku-client');

var env = [
  'COOKIE_SECRET',
  'ENCRYPTION_SECRET',
  'SESSION_SECRET'
];

env.forEach(function(key) {
  addConfig(key, secret());
});

addConfig('HEROKU_AUTH_URL', 'https://id.heroku.com');

var netrcContents = fs.readFileSync(path.join(process.env.HOME, '.netrc'));
var config        = netrc.parse(netrcContents.toString());
var token         = config['api.heroku.com'].password;
var hk            = heroku.createClient({ token: token });

hk.oauth().clients().create({
  name        : 'heroku-proxy-local',
  redirect_uri: 'http://localhost:5000/auth/heroku/callback'
}, function(err, client) {
  addConfig('HEROKU_OAUTH_ID', client.id);
  addConfig('HEROKU_OAUTH_SECRET', client.secret);
});

function addConfig(key, value) {
  fs.appendFileSync('.env', key + '=' + value + '\n');
}

function secret() {
  return crypto.randomBytes(32).toString('hex');
}
